---
title: Temporally coherent person matting trained on fake-motion dataset
permalink: /person-matting
features:
  - "A novel fake-motion algorithm for generating neural-network training video clips from a dataset of images with ground truth alpha mattes and background videos"
  - "A U-Net based deep neural network method with LSTM blocks and an attention module on skip connections" 
  - "A motion estimation based method for improving the output's temporal stability"
  - "Better than 8 different matting methods according to subjective evaluation"
---

### I. Molodetskikh, M. Erofeev, A. Moskalenko, and D. Vatolin

Contact us: 
* <ivan.molodetskikh@graphics.cs.msu.ru>
* <video@compression.ru>

<script
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
  type="text/javascript">
</script>

## Abstract
We propose a novel neural network based method to perform matting of videos depicting people that does not require additional user input such as trimaps. Our architecture achieves temporal stability of the resulting alpha mattes by using motion estimation based smoothing of image-segmentation algorithm outputs, combined with convolutional-LSTM modules on U-Net skip connections. We also propose a fake-motion algorithm that generates training clips for the video-matting network
given photos with ground truth alpha mattes and background videos. We apply random motion to photos and their mattes to simulate movement one would find in real videos and composite the result with the background clips. It lets us train a deep neural network operating on videos in an absence of a large annotated video dataset and provides ground truth training clip foreground optical flow for use in loss functions.

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">                   
 <div  class="container-buttons">
  <button class="download-button" role="button" onauxclick="window.open('https://www.sciencedirect.com/science/article/abs/pii/S1051200422001385')" onclick="window.open('https://www.sciencedirect.com/science/article/abs/pii/S1051200422001385')"> 
      Read Full Text
  </button>
  &nbsp;&nbsp;&nbsp;
 <button class="download-button" role="button" onauxclick="window.open('https://arxiv.org/pdf/2109.04843.pdf')" onclick="window.open('https://arxiv.org/pdf/2109.04843.pdf')">
     <i class="fa fa-download"></i>
     Download Full Text
 </button>
  <p class="download-button-caption">&nbsp;&nbsp;&nbsp;Newest version  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Previous version (PDF, 22.2 MB)</p>                         
</div>



## Key Features
* A novel fake-motion algorithm for generating neural-network training video clips from a dataset of images with ground truth alpha mattes and background videos
* A U-Net based deep neural network method with LSTM blocks and an attention module on skip connections
* A motion estimation based method for improving the output's temporal stability 
* Better than 8 different matting methods according to subjective evaluation powered by [Subjectify.us](https://www.subjectify.us/)

## Architecture of the proposed neural network
The figure below demonstrates the architecture. 
![architecture](/assets/img/papers/person-matting/architecture.JPG)
Some additional details:
* The outputs of the 2nd, 4th, 7th, 14th, and 18th encoder’s blocks of the TorchVision implementation are used for skip connections
* To generate the probability map we used a pretrained DeepLabv3+ image-segmentation network from TorchVision

## Dataset
We developed a novel **fake-motion algorithm** to generate training video clips from image foregrounds and video backgrounds by distorting the foreground image throughout the clip. The fake-motion procedure generates random optical-flow maps at three scales and uses them to warp the input foreground image and alpha mask to produce the foreground clip with the desired frame count.

<div>
    <img src="/assets/img/papers/person-matting/fake_motion.JPG">
    <i><center> Examples of training clips generated by our fake-motion algorithm </center></i>
</div>

To improve network resilience when a person partially leaves the video frame, we added to the optical flow a component that over the clip’s duration shifts the person halfway out of a frame and back, with a probability of $$\frac{1}{3}$$.  

## Comparison
We conducted the **subjective evaluation** using [Subjectify.us](https://www.subjectify.us/). In total more than **32,000** pairwise selections were collected and used to fit a Bradley-Terry model.

![subj_comp](/assets/img/papers/person-matting/subjective.png)

Below you can see **objective evaluation** results on clips from [VideoMatting benchmark](http://videomatting.com). The best result is shown in **bold**, the second-best
is underlined and the third-best is shown in _italics_.

<style>
table, th, td {
  border:0.8px solid black;
}
td {
  text-align: center;
  vertical-align: middle;
}
</style>

<table>  
    <tr>
        <th>Method </th>
        <th>SSDA</th> 
        <th>dtSSD</th>
        <th>&nbsp; MESSDdt &nbsp;</th>
        <th>SSDA</th>
        <th>dtSSD</th>
        <th>&nbsp; MESSDdt &nbsp;</th>
    </tr>
    <tr>
        <td></td>
        <td colspan="3">city</td>
        <td colspan="3">snow</td>
    </tr>
    <tr>
        <td>Ours</td>
        <td><i>69.651</i></td>
        <td><b>15.314</b></td>
        <td><b>0.695</b></td>
        <td>56.338</td>
        <td>30.240</td>
        <td><i>0.662</i></td>
    </tr>
    <tr>
        <td>&nbsp; Smoothed Prob. Maps &nbsp;</td>
        <td>91.577</td>
        <td><ins>17.609</ins></td>
        <td><ins>1.291</ins></td>
        <td>65.772</td>
        <td>35.133</td>
        <td>1.264</td>
    </tr>
    <tr>
        <td>FBA Matting</td>
        <td><ins>57.700</ins></td>
        <td><i>30.825</i></td>
        <td><i>1.613</i></td>
        <td><ins>27.113</ins></td>
        <td><ins>20.881</ins></td>
        <td><ins>0.423</ins></td>
    </tr>
    <tr>
        <td>Deep Image Matting</td>
        <td>97.506</td>
        <td>47.107</td>
        <td>3.258</td>
        <td>59.648</td>
        <td>41.463</td>
        <td>2.128</td>
    </tr>
    <tr>
        <td>CRGNN</td>
        <td>76.456</td>
        <td>35.591</td>
        <td>2.354</td>
        <td><i>34.735</i></td>
        <td><i>27.183</i></td>
        <td>1.244</td>
    </tr>
    <tr>
        <td>Sem. Human Matting</td>
        <td>108.393</td>
        <td>&nbsp; 53.086 &nbsp;</td>
        <td>5.696</td>
        <td>71.844</td>
        <td>43.689</td>
        <td>2.595</td>
    </tr>
    <tr>
        <td>Late Fusion Matting</td>
        <td><b>44.766</b></td>
        <td>31.621</td>
        <td>4.152</td>
        <td><b>24.602</b></td>
        <td><b>19.484</b></td>
        <td><b>0.341</b></td>
    </tr>
    <tr>
        <td>COSNet</td>
        <td>&nbsp; 271.878 &nbsp;</td>
        <td>62.798</td>
        <td>22.387</td>
        <td>156.617</td>
        <td>58.536</td>
        <td>9.424</td>
    </tr>
    <tr>
        <td>MMNet</td>
        <td>154.656</td>
        <td>62.439</td>
        <td>13.580</td>
        <td>&nbsp;347.065&nbsp;</td>
        <td>&nbsp;143.696&nbsp;</td>
        <td>58.429</td>
    </tr>
</table>
  
The second table shows objective evaluation results on five **VideoMatte240K** test clips.  
  
|-----------------+-----------------+-----------------+----------------|
| &nbsp; Method &nbsp; | &nbsp; SSDA &nbsp; | &nbsp; dtSSD &nbsp; | &nbsp; MESSDdt &nbsp; |
|:---------------:|:---------------:|:---------------:|:---------------:|
| Ours | _84.710_ | _46.792_ | <ins>2.080</ins> |
|&nbsp; Smoothed Prob. Maps &nbsp;|  117.253 | 53.836 | 4.452 |
| FBA Matting | <ins>62.679</ins> | <ins>40.996</ins> | _2.901_ |
| Deep Image Matting | 165.094 | 100.595 | 15.039 |
| CRGNN | 140.095 | 84.434 | 13.900 |
| Sem. Human Matting | 166.325 | 113.648 | 22.300 |
| Late Fusion Matting | **29.146** | **25.459** | **0.845** |
| COSNet | 226.256 | 74.765 | 17.506 |
| MMNet | &nbsp; 445.550 &nbsp; | &nbsp;156.778 &nbsp;| 75.171 |
|:---------------:|:---------------:|:---------------:|:---------------:|
{: .tablelines}
  
The third table shows objective evaluation results on 100 **fake-motion** clips.  
  
|-----------------+-----------------+-----------------+----------------|
| &nbsp; Method &nbsp; | &nbsp; SSDA &nbsp; | &nbsp; dtSSD &nbsp; | &nbsp; MESSDdt &nbsp; |
|:---------------:|:---------------:|:---------------:|:---------------:|
| Ours | **102.371** | **72.880** | **1.818** |
| &nbsp; Smoothed Prob. Maps &nbsp; |  <ins>113.019</ins> | <ins>79.253</ins> | <ins>3.955</ins> |
| FBA Matting | _114.101_ | _92.686_ | _4.613_ |
| Deep Image Matting | 128.205 | 113.675 | 7.693 |
| CRGNN | 121.416 | 95.899 | 7.015 |
| Sem. Human Matting |  186.980 | 145.235 | 9.685 |
| Late Fusion Matting |&nbsp; 454.597&nbsp; | &nbsp; 222.736 &nbsp;| 69.992 |
| COSNet | 610.056 | 142.895 | 33.037 |
| MMNet |  222.333 | 124.414 | 15.006 |
|:---------------:|:---------------:|:---------------:|:---------------:|
{: .tablelines}

We believe the discrepancy between the subjective and the objective evaluation results can be attributed to the existing objective metrics' limited ability to distinguish temporal coherence.

## Cite us
{% highlight BibTeX %}
@article{MOLODETSKIKH2022103521,
title = {Temporally coherent person matting trained on fake-motion dataset},
journal = {Digital Signal Processing},
volume = {126},
pages = {103521},
year = {2022},
issn = {1051-2004},
doi = {https://doi.org/10.1016/j.dsp.2022.103521},
url = {https://www.sciencedirect.com/science/article/pii/S1051200422001385},
author = {Ivan Molodetskikh and Mikhail Erofeev and Andrey Moskalenko and Dmitry Vatolin},
keywords = {Video matting, Semantic person matting, Semantic segmentation, Data augmentation, Temporal smoothing, Deep learning},
abstract = {We propose a novel neural network based method to perform matting of videos depicting people that does not require additional user input such as trimaps. Our architecture achieves temporal stability of the resulting alpha mattes by using motion estimation based smoothing of image-segmentation algorithm outputs, combined with convolutional-LSTM modules on U-Net skip connections. We also propose a fake-motion algorithm that generates training clips for the video-matting network given photos with ground truth alpha mattes and background videos. We apply random motion to photos and their mattes to simulate movement one would find in real videos and composite the result with the background clips. It lets us train a deep neural network operating on videos in an absence of a large annotated video dataset and provides ground truth training clip foreground optical flow for use in loss functions.}
}
{% endhighlight %}

## Contact us

For questions and propositions, please contact us: <ivan.molodetskikh@graphics.cs.msu.ru>, <video@compression.ru>

## See also 
* [VideoMatting benchmark](http://videomatting.com)
* [Subjectify.us](https://www.subjectify.us/)
* [MSU benchmarks](https://videoprocessing.ai/benchmarks/)

## References

1) M. Sandler, A. Howard, M. Zhu, A. Zhmoginov, and L.-C. Chen, “Mobilenetv2: inverted residuals and linear bottlenecks,” in The IEEE Conference on Computer Vision and Pattern Recognition (CVPR), 2018.

2) X. Shi, Z. Chen, H. Wang, D.-Y. Yeung, W.-k. Wong, and W.-c. Woo, “Convolutional LSTM Network: A Machine Learning Approach for Precipitation Nowcasting,” in Advances in Neural Information Processing Systems, vol. 28, Curran Associates, Inc., 2015, pp. 802–810.

3) A. Vaswani, N. Shazeer, N. Parmar, J. Uszkoreit, L. Jones, A.N. Gomez, Ł. Kaiser, and I. Polosukhin, “Attention is all you need,” in Advances in Neural Information Processing Systems, 2017, pp. 5998–6008.

4) L.-C. Chen, Y. Zhu, G. Papandreou, F. Schroff, and H. Adam, “Encoder-decoder with atrous separable convolution for semantic image segmentation,” in Proceedings of the European Conference on Computer Vision (ECCV), 2018.

5) AISegment dataset, available: [https://github.com/aisegmentcn/matting_human_datasets/tree/1829b5f722024d29b780993f06b45ea3f47ba777](https://github.com/aisegmentcn/matting_human_datasets/tree/1829b5f722024d29b780993f06b45ea3f47ba777), 2019.

6) X. Shen, X. Tao, H. Gao, C. Zhou, and J. Jia, “Deep automatic portrait matting,” in European Conference on Computer Vision, Springer, 2016, pp. 92–107.

7) N. Xu, B. Price, S. Cohen, and T. Huang, “Deep image matting,” in The IEEE Conference on Computer Vision and Pattern Recognition (CVPR), 2017.

8) M. Forte, F. Pitié, “F, B, alpha matting,” preprint, arXiv:2003.07711, 2020.

9) X. Lu, W. Wang, C. Ma, J. Shen, L. Shao, and F. Porikli, “See more, know more: unsupervised video object segmentation with co-attention siamese networks,” in Proceedings of the IEEE/CVF Conference on Computer Vision and Pattern Recognition (CVPR), 2019.

10) S. Seo, S. Choi, M. Kersner, B. Shin, H. Yoon, H. Byun, and S. Ha, “Towards realtime automatic portrait matting on mobile devices,” preprint, arXiv:1904.03816, 2019.

11) Q. Chen, T. Ge, Y. Xu, Z. Zhang, X. Yang, and K. Gai, “Semantic human matting,” in Proceedings of the 26th ACM International Conference on Multimedia, 2018, pp. 618-626.

12) Y. Zhang, L. Gong, L. Fan, P. Ren, Q. Huang, H. Bao, and W. Xu, “A late fusion CNN for digital matting,” in Proceedings of the IEEE/CVF Conference on Computer Vision and Pattern Recognition (CVPR), 2019.

13) T. Wang, S. Liu, Y. Tian, K. Li, and M.-H. Yang, “Video matting via consistency-regularized graph neural networks,” in Proceedings of the IEEE/CVF International Conference on Computer Vision (ICCV), 2021, pp. 4902–4911.

14) R.A. Bradley, and M.E. Terry, “Rank analysis of incomplete block designs: I. The method of paired comparisons,” in Biometrika 39 (3/4) (1952) 324–345.
